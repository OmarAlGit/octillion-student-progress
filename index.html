<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Group 1 â€” Student Assessments</title>

  <!-- Clean font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0f1822;          /* dark board */
      --panel:#0b141d;
      --firstcol:#cfd3d7;    /* wide grey first column */
      --head:#d9ecff;        /* light-blue headers */
      --grid:#243140;

      --chip-r:#e53935;      /* red */
      --chip-a:#f39c12;      /* amber */
      --chip-g:#2ecc71;      /* green */

      --chip-r-t:#ffffff;
      --chip-a-t:#ffffff;
      --chip-g-t:#ffffff;
    }

    *{ box-sizing: border-box }
    html,body{ height:100% }
    body{
      margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg); color:#e9eef5;
    }

    header{
      padding:14px 16px; text-align:center; font-weight:800; letter-spacing:.3px;
      background:#0b1520; border-bottom:1px solid var(--grid);
    }

    .wrap{
      max-width: 1600px; margin: 18px auto; padding: 0 16px;
    }

    .board{
      border:1px solid var(--grid);
      background:#0b1520;
      border-radius:14px;
      overflow:auto;
      box-shadow: 0 20px 60px rgba(0,0,0,.3);
    }

    table{ border-collapse: separate; border-spacing:0; width:max-content; min-width:100%; }

    /* header row (two lines inside each header cell) */
    thead th{
      position: sticky; top: 0; z-index: 5;
      background: var(--head); color:#0c1722;
      border-right: 1px solid var(--grid);
      border-bottom: 2px solid var(--grid);
      padding: 8px 12px; text-align: center; min-width: 260px;
    }
    thead th:first-child{
      min-width: 260px; background: var(--firstcol); left:0; position:sticky; z-index:6;
    }

    .h-top{ display:block; font-weight:800; font-size:22px; line-height:1.2; }
    .h-sub{ display:block; font-weight:700; font-size:16px; opacity:.9; margin-top:4px; }

    /* sticky first column for names */
    tbody td:first-child, thead th:first-child{
      position: sticky; left: 0;
      background: var(--firstcol); color:#0b0f13; text-align:center; font-weight:800;
      border-right:1px solid var(--grid);
    }

    tbody td{
      border-right:1px solid var(--grid);
      border-bottom:1px solid var(--grid);
      padding: 16px; text-align:center; background:#0f1b27;
    }

    tbody tr:nth-child(even) td{ background:#0e1a25; }

    .cell{
      margin:auto; width: 92%; max-width: 380px;
      border-radius: 18px; padding: 16px 18px;
      color: #fff; box-shadow: inset 0 0 0 2px rgba(255,255,255,.08);
    }
    .cell.red   { background: var(--chip-r); color: var(--chip-r-t); }
    .cell.amber { background: var(--chip-a); color: var(--chip-a-t); }
    .cell.green { background: var(--chip-g); color: var(--chip-g-t); }

    .lab{ font-weight:800; margin-right:6px; }
    .row{ display:flex; justify-content:center; gap:12px; }
    .kv{ font-weight:700; }

    .stamp{ text-align:right; color:#8ea4bd; font-size:12px; padding:10px 6px; }
  </style>
</head>
<body>
  <header>Group 1 â€” Student Assessments</header>

  <div class="wrap">
    <div class="board">
      <table id="grid">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="stamp" id="stamp">Loadingâ€¦</div>
  </div>

  <script>
    // ðŸ‘‰ Your live Tracking sheet CSV (published)
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRTW5UzVfnAcBJdW9fSL7SXFc0wtUV5ftFWKaFExTPhq7FTv5QZ0rHqjs4sLlBnFHzCi0ThHMzV3rT_/pub?gid=1926586971&single=true&output=csv";

    // --- CSV parser (handles quotes) ---
    function parseCSV(text){
      const out = [], row = [];
      let i=0, cell="", q=false;
      const push=()=>{ row.push(cell); cell=""; };
      const newRow=()=>{ out.push(row.slice()); row.length=0; };
      while(i<text.length){
        const c=text[i], n=text[i+1];
        if(q){
          if(c=='"' && n=='"'){ cell+='"'; i+=2; continue; }
          if(c=='"'){ q=false; i++; continue; }
          cell+=c; i++; continue;
        }else{
          if(c=='"'){ q=true; i++; continue; }
          if(c==','){ push(); i++; continue; }
          if(c=='\r'){ i++; continue; }
          if(c=='\n'){ push(); newRow(); i++; continue; }
          cell+=c; i++; continue;
        }
      }
      if(cell.length||row.length){ push(); newRow(); }
      return out.filter(r=>r.length);
    }

    // Dates: accept dd/mm/yyyy or Excel serials, or "N/A"
    const pad = n => n<10 ? "0"+n : ""+n;
    function serialToDate(s){
      const base = new Date(Date.UTC(1899,11,30));
      const t = base.getTime() + Number(s)*86400000;
      const d = new Date(t);
      return `${pad(d.getUTCDate())} ${d.toLocaleString('en-GB',{month:'short'})} ${d.getUTCFullYear()}`;
    }
    function normaliseDate(v){
      const x = (v||"").toString().trim().replaceAll("//","/").replaceAll("-","/");
      if(!x || /^n\/?a$/i.test(x) || /^n$/i.test(x)) return "N/A";
      if(/^\d+$/.test(x) && Number(x)>=30000 && Number(x)<=60000) return serialToDate(x);
      // dd/mm/yyyy
      const m = x.match(/^(\d{1,2})[\/](\d{1,2})[\/](\d{4})$/);
      if(m){
        const d = new Date(+m[3], +m[2]-1, +m[1]);
        return `${pad(d.getDate())} ${d.toLocaleString('en-GB',{month:'short'})} ${d.getFullYear()}`;
      }
      return x; // leave text
    }

    // Build the board from a "wide" sheet with Start/End pairs
    function buildBoard(rows){
      if(rows.length < 3) return;
      const head1 = rows[0];      // e.g., "Student", "H&S 1 Start", "H&S 1 End", ...
      const head2 = rows[1];      // e.g., "", "Identifying Hazards", "Identifying Hazards", ...

      // Find Start/End pairs per assessment
      const pairs = []; // [{key:'H&S 1', topic:'Identifying Hazards', startCol:1, endCol:2}, ...]
      for(let c=1; c<head1.length; c++){
        const h = (head1[c]||"").trim();
        if(/start$/i.test(h)){
          const base = h.replace(/\s*start$/i,"").trim();
          const endIdx = c+1;
          const endHeader = (head1[endIdx]||"").trim();
          if(new RegExp(`^${base}\\s*end$`,"i").test(endHeader)){
            const topic = (head2[c] || head2[endIdx] || "").trim();
            pairs.push({ key: base, topic, startCol:c, endCol:endIdx });
            c = endIdx; // skip the next one (paired)
          }
        }
      }

      // Render thead: first col (names) + one col per assessment (with two-line header)
      const thead = document.getElementById("thead");
      const tbody = document.getElementById("tbody");
      thead.innerHTML = "";
      tbody.innerHTML = "";

      const hCells = [`<th><span class="h-top">Group 1</span><span class="h-sub">&nbsp;</span></th>`]
        .concat(pairs.map(p => `<th><span class="h-top">${p.key}</span><span class="h-sub">${p.topic||""}</span></th>`))
        .join("");
      thead.innerHTML = `<tr>${hCells}</tr>`;

      // Body rows (students)
      for(let r=2; r<rows.length; r++){
        const name = (rows[r][0]||"").trim();
        if(!name) continue;

        const tds = [`<td>${name}</td>`];

        pairs.forEach(p=>{
          const sRaw = rows[r][p.startCol] || "";
          const eRaw = rows[r][p.endCol]   || "";
          const s = normaliseDate(sRaw);
          const e = normaliseDate(eRaw);

          let cls = "red";
          if(s!=="N/A" && e==="N/A") cls = "amber";
          if(s!=="N/A" && e!=="N/A") cls = "green";

          tds.push(
            `<td>
               <div class="cell ${cls}">
                 <div class="row"><span class="lab">Start:</span> <span class="kv">${s}</span></div>
                 <div class="row" style="margin-top:6px;"><span class="lab">End:</span> <span class="kv">${e}</span></div>
               </div>
             </td>`
          );
        });

        tbody.insertAdjacentHTML("beforeend", `<tr>${tds.join("")}</tr>`);
      }
    }

    async function load(){
      const stamp = document.getElementById("stamp");
      try{
        const res = await fetch(sheetUrl + "&cb=" + Date.now()); // cache-bust
        const text = await res.text();
        const rows = parseCSV(text);
        buildBoard(rows);
        const now = new Date();
        stamp.textContent = `Last updated: ${now.toLocaleTimeString()}`;
      }catch(e){
        console.error(e);
        stamp.textContent = "Error loading data. Check the published CSV link.";
      }
    }

    load();
    setInterval(load, 120000); // refresh every 2 minutes
  </script>
</body>
</html>
