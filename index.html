<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Group 1 â€” Assessments Board</title>

  <!-- Clean UI font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0f1822;          /* dark background */
      --panel:#0b1520;
      --firstcol:#cfd3d7;    /* wide grey first column */
      --head:#d9ecff;        /* light-blue headers */
      --grid:#223144;

      --red:#e74c3c;
      --amber:#f39c12;
      --green:#27ae60;

      --card-bg:#0c1722;
      --card-alt:#0f1b27;
      --text:#e9eef5;
    }

    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg); color:var(--text);
    }

    header{
      text-align:center; font-weight:800; letter-spacing:.3px;
      padding:14px 16px; background:#0b1520; border-bottom:1px solid var(--grid);
    }

    .wrap{ max-width:1700px; margin:18px auto; padding:0 16px; }

    .board{
      border:1px solid var(--grid);
      background:#0b1520;
      border-radius:14px;
      overflow:auto;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
    }

    table{ border-collapse:separate; border-spacing:0; width:max-content; min-width:100%; }

    /* HEADER */
    thead th{
      position:sticky; top:0; z-index:5;
      background:var(--head); color:#0c1722;
      border-right:1px solid var(--grid);
      border-bottom:2px solid var(--grid);
      padding:10px 12px; text-align:center; min-width:320px;
    }
    thead th:first-child{
      min-width:300px; background:var(--firstcol); left:0; position:sticky; z-index:6;
    }
    .h-top{ display:block; font-weight:800; font-size:22px; line-height:1.25; }
    .h-sub{ display:block; font-weight:700; font-size:16px; opacity:.9; margin-top:4px; }

    /* BODY */
    tbody td{
      border-right:1px solid var(--grid);
      border-bottom:1px solid var(--grid);
      padding:18px; text-align:center; background:var(--card-bg);
    }
    tbody tr:nth-child(even) td{ background:var(--card-alt); }

    /* sticky first column for student names */
    tbody td:first-child, thead th:first-child{
      position:sticky; left:0;
      background:var(--firstcol); color:#0b0f13;
      font-weight:800; text-align:center;
      border-right:1px solid var(--grid);
    }

    /* coloured block */
    .cell{
      margin:auto; width:92%; max-width:420px;
      border-radius:22px; padding:18px 20px;
      color:#fff; box-shadow: inset 0 0 0 2px rgba(255,255,255,.08);
    }
    .red{   background:var(--red); }
    .amber{ background:var(--amber); }
    .green{ background:var(--green); }

    .row{ display:flex; justify-content:center; gap:10px; }
    .lab{ font-weight:800; }
    .kv{ font-weight:700; }

    .stamp{ text-align:right; color:#90a4bf; font-size:12px; padding:10px 6px; }
  </style>
</head>
<body>
  <header>Group 1 â€” Student Assessments</header>

  <div class="wrap">
    <div class="board">
      <table id="grid">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="stamp" id="stamp">Loadingâ€¦</div>
  </div>

  <script>
    // ðŸ‘‰ Your live Tracking sheet CSV (tall/long format)
    const sheetUrl =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRTW5UzVfnAcBJdW9fSL7SXFc0wtUV5ftFWKaFExTPhq7FTv5QZ0rHqjs4sLlBnFHzCi0ThHMzV3rT_/pub?gid=1926586971&single=true&output=csv";

    /* ---------- CSV + date helpers ---------- */
    function parseCSV(text){
      const out=[], row=[]; let i=0, cell="", q=false;
      const push=()=>{ row.push(cell); cell=""; };
      const newRow=()=>{ out.push(row.slice()); row.length=0; };
      while(i<text.length){
        const c=text[i], n=text[i+1];
        if(q){
          if(c=='"' && n=='"'){ cell+='"'; i+=2; continue; }
          if(c=='"'){ q=false; i++; continue; }
          cell+=c; i++; continue;
        }else{
          if(c=='"'){ q=true; i++; continue; }
          if(c==','){ push(); i++; continue; }
          if(c=='\r'){ i++; continue; }
          if(c=='\n'){ push(); newRow(); i++; continue; }
          cell+=c; i++; continue;
        }
      }
      if(cell.length||row.length){ push(); newRow(); }
      return out.filter(r=>r.length);
    }

    const pad=n=>n<10?"0"+n:""+n;
    function serialToDMY(serial){
      const base=new Date(Date.UTC(1899,11,30));
      const t=base.getTime()+Number(serial)*86400000;
      const d=new Date(t);
      return `${pad(d.getUTCDate())} ${d.toLocaleString('en-GB',{month:'short'})} ${d.getUTCFullYear()}`;
    }
    function normaliseDate(v){
      const x=(v||"").toString().trim().replaceAll("//","/").replaceAll("-","/");
      if(!x || /^n\/?a$/i.test(x) || /^n$/i.test(x)) return null;
      if(/^\d+$/.test(x) && Number(x)>=30000 && Number(x)<=60000) return serialToDMY(x);
      const m=x.match(/^(\d{1,2})[\/](\d{1,2})[\/](\d{4})$/);
      if(m){ const d=new Date(+m[3],+m[2]-1,+m[1]); return `${pad(d.getDate())} ${d.toLocaleString('en-GB',{month:'short'})} ${d.getFullYear()}`; }
      return x; // leave text as-is
    }

    /* ---------- Transform tall sheet -> board model ---------- */
    // Expect headers: "Date / Status" | "Task Code" | "Topic" | "Student"
    function buildModel(rows){
      if(rows.length<2) return {students:[], topics:[], map:{}};

      const header = rows[0].map(h=>h.trim().toLowerCase());
      const cDate = header.indexOf("date / status");
      const cCode = header.indexOf("task code");
      const cTopic = header.indexOf("topic");
      const cStud = header.indexOf("student");
      if(cDate<0 || cCode<0 || cTopic<0 || cStud<0){
        console.warn("Header columns not found. Expected: Date / Status | Task Code | Topic | Student");
      }

      const studentsSet = new Set();
      const topicOrder = [];              // keep first-seen order
      const topicSeen  = new Set();
      const buckets = {};                 // buckets[student][topicKey] = array of dates

      for(let r=1; r<rows.length; r++){
        const row = rows[r];
        const rawDate  = row[cDate]  ?? "";
        const code     = (row[cCode]  ?? "").trim();
        const topic    = (row[cTopic] ?? "").trim();
        const student  = (row[cStud]  ?? "").trim();
        if(!student || !code) continue;

        studentsSet.add(student);

        const topicKey = `${code}|||${topic}`; // stable key
        if(!topicSeen.has(topicKey)){
          topicSeen.add(topicKey);
          topicOrder.push({ key: topicKey, code, topic });
        }

        const nDate = normaliseDate(rawDate); // null if N/A/blank
        if(!buckets[student]) buckets[student]={};
        if(!buckets[student][topicKey]) buckets[student][topicKey]=[];
        if(nDate) buckets[student][topicKey].push(nDate);
      }

      const students = Array.from(studentsSet);
      students.sort((a,b)=>a.localeCompare(b)); // alphabetical names

      return { students, topics: topicOrder, data: buckets };
    }

    function decideCell(dates){
      // dates = [] | [date] | [d1,d2,...]
      if(!dates || dates.length===0) return {cls:"red",   start:"N/A", end:"N/A"};
      if(dates.length===1)           return {cls:"amber", start:dates[0], end:"N/A"};
      // pick min as start, max as end (string dates are in "DD Mon YYYY" so sort via Date)
      const sorted = dates.slice().sort((a,b)=> new Date(a) - new Date(b));
      return {cls:"green", start:sorted[0], end:sorted[sorted.length-1]};
    }

    /* ---------- Render ---------- */
    function renderBoard(model){
      const thead = document.getElementById("thead");
      const tbody = document.getElementById("tbody");

      // build header row: first cell "Group 1", then each topic column (two-line)
      const headCells = [
        `<th><span class="h-top">Group 1</span><span class="h-sub">&nbsp;</span></th>`
      ].concat(
        model.topics.map(t =>
          `<th><span class="h-top">${t.code}</span><span class="h-sub">${t.topic}</span></th>`
        )
      ).join("");
      thead.innerHTML = `<tr>${headCells}</tr>`;

      // body rows: one per student
      tbody.innerHTML = "";
      model.students.forEach(student => {
        const tds = [`<td>${student}</td>`];
        model.topics.forEach(t => {
          const dates = (model.data[student] && model.data[student][t.key]) || [];
          const d = decideCell(dates);
          tds.push(
            `<td>
              <div class="cell ${d.cls}">
                <div class="row"><span class="lab">Start:</span><span class="kv">${d.start}</span></div>
                <div class="row" style="margin-top:6px;"><span class="lab">End:</span><span class="kv">${d.end}</span></div>
              </div>
            </td>`
          );
        });
        tbody.insertAdjacentHTML("beforeend", `<tr>${tds.join("")}</tr>`);
      });
    }

    async function load(){
      const stamp = document.getElementById("stamp");
      try{
        const res = await fetch(sheetUrl + "&cb=" + Date.now()); // cache-bust
        const text = await res.text();
        const rows = parseCSV(text);
        const model = buildModel(rows);
        renderBoard(model);
        const now = new Date();
        stamp.textContent = "Last updated: " + now.toLocaleTimeString();
      }catch(e){
        console.error(e);
        stamp.textContent = "Error loading data (check CSV link)";
      }
    }

    load();
    setInterval(load, 120000); // refresh every 2 minutes
  </script>
</body>
</html>
