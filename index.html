<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Progress ‚Äì Tracking Grid</title>
  <style>
    :root{
      --brand:#0d47a1;
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --ok:#2e7d32;
      --no:#c62828;
      --border:#e5e7eb;
      --row:#f9fafb;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(135deg,#f8fafc,#e8f0fe);
      color:var(--text); font-family:Segoe UI,system-ui,Arial,sans-serif;
    }
    header{
      position:sticky; top:0; z-index:5;
      background:var(--brand); color:#fff; text-align:center;
      padding:14px 10px; box-shadow:0 2px 10px rgba(0,0,0,.08);
      letter-spacing:.2px; font-weight:600;
    }
    main{ max-width:1400px; margin:22px auto; padding:0 16px; }
    .card{
      background:var(--card); border-radius:16px; padding:16px;
      box-shadow:0 10px 30px rgba(13,71,161,.08);
      border:1px solid var(--border);
    }

    /* Grid wrapper (scrolls horizontally on small screens) */
    .grid-wrap{
      overflow:auto; border-radius:12px; border:1px solid var(--border);
      background:#fff;
    }

    table{
      border-collapse:separate; border-spacing:0; width:max-content; min-width:100%;
      font-size:14px; line-height:1.35;
    }
    thead th{
      position:sticky; top:0; z-index:3;
      background:var(--brand); color:#fff; font-weight:600;
      padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.25);
      white-space:nowrap;
    }
    th, td{
      border-right:1px solid var(--border);
      border-bottom:1px solid var(--border);
      padding:8px 10px; background:#fff;
    }
    tbody tr:nth-child(even) td{ background:var(--row); }

    /* Sticky first two columns (Task Code, Topic/Desc) */
    .sticky-1{ position:sticky; left:0; z-index:2; background:#eef2ff; font-weight:600; }
    .sticky-2{ position:sticky; left:180px; z-index:2; background:#eef2ff; min-width:280px; }
    /* Make first header cells sticky, too */
    thead th.sticky-1{ left:0; z-index:4; background:#0c3f91; }
    thead th.sticky-2{ left:180px; z-index:4; background:#0c3f91; }

    /* Cell badges */
    .cell{ display:flex; align-items:center; gap:8px; }
    .ok{ color:var(--ok); font-weight:600; }
    .no{ color:var(--no); font-weight:600; }
    .muted{ color:var(--muted); }

    .legend{
      display:flex; gap:18px; align-items:center; flex-wrap:wrap;
      color:var(--muted); font-size:13px; margin:10px 0 14px;
    }
    .pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px;
      border-radius:999px; background:#eef2ff; border:1px solid var(--border) }

    .toolbar{
      display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:10px;
    }
    .updated{ color:var(--muted); font-size:12px; }
    .title{ font-size:18px; font-weight:700; color:var(--brand); }

    @media (max-width: 900px){
      .sticky-2{ left:160px; min-width:220px; }
      thead th.sticky-2{ left:160px; }
    }
  </style>
</head>
<body>
  <header>üìä Student Progress ‚Äì Tracking Grid</header>
  <main>
    <div class="card">
      <div class="toolbar">
        <div class="title">Live from Google Sheets (Web Data)</div>
        <div class="legend">
          <span class="pill"><span class="ok">‚úÖ</span> Completed (date/value)</span>
          <span class="pill"><span class="no">‚ùå</span> N / empty</span>
          <span class="pill"><span>Œ£</span> Totals column kept</span>
        </div>
      </div>
      <div class="updated" id="updated">Loading‚Ä¶</div>
      <div class="grid-wrap">
        <table id="grid">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    // üëâ REPLACE with your published CSV link:
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRTW5UzVfnAcBJdW9fSL7SXFc0wtUV5ftFWKaFExTPhq7FTv5QZ0rHqjs4sLlBnFHzCi0ThHMzV3rT_/pub?gid=1451995921&single=true&output=csv";

    // --- utils ---
    const fmt = n => n < 10 ? "0"+n : n;
    function excelSerialToDate(serial){
      const base = new Date(Date.UTC(1899,11,30)); // Google/Excel epoch
      const d = new Date(base.getTime() + serial * 86400000);
      const dd = fmt(d.getUTCDate()), mm = fmt(d.getUTCMonth()+1), yy = d.getUTCFullYear();
      return `${dd}/${mm}/${yy}`;
    }
    function isLikelySerial(val){
      if(!/^\d+$/.test(val)) return false;
      const n = Number(val);
      // Typical modern date serial range
      return n >= 30000 && n <= 60000;
    }
    function isDateText(val){
      // Accept 1/2/2024 or 01/02/2024 (and with // typos)
      return /^(0?[1-9]|[12]\d|3[01])[\/]{1,2}(0?[1-9]|1[0-2])[\/]{1,2}(19|20)\d{2}$/.test(val.trim());
    }
    function cleanDate(val){
      const v = val.replaceAll("//","/").trim();
      if (isLikelySerial(v)) return excelSerialToDate(Number(v));
      if (isDateText(v)) {
        // normalise to DD/MM/YYYY
        const parts = v.split(/[\/]+/).map(x=>x.trim());
        const dd = fmt(Number(parts[0])), mm = fmt(Number(parts[1])), yy = parts[2];
        return `${dd}/${mm}/${yy}`;
      }
      return v; // not a date; may be "N" or blank
    }

    // Robust CSV parser (handles quotes and commas)
    function parseCSV(text){
      const rows = [];
      let row = [], i = 0, cur = "", inQ = false;
      while(i < text.length){
        const ch = text[i], nxt = text[i+1];
        if(inQ){
          if(ch === '"' && nxt === '"'){ cur += '"'; i+=2; continue; }
          if(ch === '"'){ inQ = false; i++; continue; }
          cur += ch; i++; continue;
        }else{
          if(ch === '"'){ inQ = true; i++; continue; }
          if(ch === ','){ row.push(cur); cur=""; i++; continue; }
          if(ch === '\r'){ i++; continue; }
          if(ch === '\n'){ row.push(cur); rows.push(row); row=[]; cur=""; i++; continue; }
          cur += ch; i++; continue;
        }
      }
      if(cur.length || row.length) { row.push(cur); rows.push(row); }
      return rows;
    }

    function renderGrid(matrix){
      const grid = document.getElementById("grid");
      const thead = grid.querySelector("thead");
      const tbody = grid.querySelector("tbody");
      if (!matrix || !matrix.length){ thead.innerHTML=""; tbody.innerHTML=""; return; }

      // We render EXACT layout:
      // row0 = headers, col0 = Task Code, col1 = Topic/Description, col2+ = students (including Totals if present)
      const headers = matrix[0];
      const data = matrix.slice(1);

      // Build header (sticky first two columns)
      const ths = headers.map((h, idx) => {
        const cls = idx===0 ? ' class="sticky-1"' : (idx===1 ? ' class="sticky-2"' : '');
        return `<th${cls}>${h || ""}</th>`;
      }).join("");
      thead.innerHTML = `<tr>${ths}</tr>`;

      // Build rows
      const rowsHtml = data.map(r => {
        return "<tr>" + r.map((cell, cIdx) => {
          let content = (cell ?? "").toString();

          // Style first two columns as sticky label columns
          const stickyCls = cIdx===0 ? "sticky-1" : (cIdx===1 ? "sticky-2" : "");

          // Decide how to render student cells (cIdx >= 2)
          if (cIdx >= 2){
            const raw = content.trim();
            if (!raw){
              content = `<span class="cell muted">‚Äî</span>`;
            } else if (/^n$/i.test(raw)){
              content = `<span class="cell no">‚ùå N</span>`;
            } else {
              const dateOrVal = cleanDate(raw);
              // treat any non-N value as completed
              content = `<span class="cell ok">‚úÖ ${dateOrVal}</span>`;
            }
          }
          return `<td class="${stickyCls}">${content}</td>`;
        }).join("") + "</tr>";
      }).join("");
      tbody.innerHTML = rowsHtml;
    }

    async function load(){
      const updated = document.getElementById("updated");
      try{
        const res = await fetch(sheetUrl + "&cacheBust=" + Date.now());
        if(!res.ok) throw new Error("HTTP " + res.status);
        const text = await res.text();
        const matrix = parseCSV(text);
        renderGrid(matrix);
        const d = new Date();
        updated.textContent = "Last updated: " + 
          d.getHours().toString().padStart(2,"0")+":"+
          d.getMinutes().toString().padStart(2,"0");
      }catch(e){
        console.error(e);
        updated.textContent = "Error loading data. Check the published CSV link.";
      }
    }

    load();
    setInterval(load, 120000); // refresh every 2 minutes
  </script>
</body>
</html>
