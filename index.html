<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Progress Dashboard</title>
  <style>
    :root {
      --brand: #1565c0;
      --header-bg: #1976d2;
      --header-text: #ffffff;
      --ok: #2e7d32;
      --no: #c62828;
      --border: #e0e0e0;
      --bg: #f5f7fa;
      --row-alt: #f9fbfd;
      --sticky-bg: #e8f0fe;
      --text: #1a1a1a;
    }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
    }

    header {
      background: var(--header-bg);
      color: var(--header-text);
      text-align: center;
      padding: 1rem;
      font-size: 1.6rem;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    main {
      padding: 2rem;
      max-width: 1600px;
      margin: auto;
    }

    .sheet-container {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      overflow: auto;
      border: 1px solid var(--border);
    }

    table {
      border-collapse: collapse;
      width: max-content;
      min-width: 100%;
      font-size: 14px;
    }

    th, td {
      border: 1px solid var(--border);
      padding: 8px 12px;
      text-align: center;
      white-space: nowrap;
    }

    thead th {
      position: sticky;
      top: 0;
      background: var(--header-bg);
      color: var(--header-text);
      font-weight: 600;
      z-index: 3;
    }

    tbody tr:nth-child(even) td {
      background: var(--row-alt);
    }

    td.sticky-col {
      position: sticky;
      left: 0;
      z-index: 2;
      background: var(--sticky-bg);
      font-weight: 600;
      text-align: left;
    }

    td.sticky-col-2 {
      position: sticky;
      left: 180px;
      z-index: 2;
      background: var(--sticky-bg);
      font-weight: 600;
      text-align: left;
    }

    thead th.sticky-col {
      left: 0;
      z-index: 4;
      background: var(--brand);
    }

    thead th.sticky-col-2 {
      left: 180px;
      z-index: 4;
      background: var(--brand);
    }

    .ok {
      color: var(--ok);
      font-weight: 600;
    }

    .no {
      color: var(--no);
      font-weight: 600;
    }

    .muted {
      color: #777;
    }

    .footer {
      text-align: right;
      font-size: 12px;
      color: #777;
      margin-top: 10px;
    }

    .loading {
      text-align: center;
      padding: 1rem;
      color: var(--brand);
    }

    @media (max-width: 900px) {
      td.sticky-col-2, thead th.sticky-col-2 { left: 140px; }
    }
  </style>
</head>
<body>
  <header>üìä Student Progress Dashboard</header>
  <main>
    <div class="sheet-container">
      <div id="loading" class="loading">Loading latest data...</div>
      <table id="sheet">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="footer" id="last-updated">Last updated: ‚Äî</div>
  </main>

  <script>
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRTW5UzVfnAcBJdW9fSL7SXFc0wtUV5ftFWKaFExTPhq7FTv5QZ0rHqjs4sLlBnFHzCi0ThHMzV3rT_/pub?gid=1926586971&single=true&output=csv";

    const table = document.getElementById("sheet");
    const thead = table.querySelector("thead");
    const tbody = table.querySelector("tbody");
    const loading = document.getElementById("loading");
    const updated = document.getElementById("last-updated");

    function parseCSV(text) {
      const rows = [];
      let current = [], i = 0, inQuotes = false;
      while (i < text.length) {
        const char = text[i];
        if (inQuotes) {
          if (char === '"' && text[i + 1] === '"') { current.push('"'); i++; }
          else if (char === '"') inQuotes = false;
          else current.push(char);
        } else {
          if (char === '"') inQuotes = true;
          else if (char === ',') { rows.push(current.join('')); current = []; }
          else if (char === '\n') { rows.push(current.join('')); rows.push('\n'); current = []; }
          else current.push(char);
        }
        i++;
      }
      rows.push(current.join(''));
      const lines = [];
      let line = [];
      rows.forEach(r => {
        if (r === '\n') { lines.push(line); line = []; }
        else line.push(r);
      });
      if (line.length) lines.push(line);
      return lines;
    }

    function excelSerialToDate(serial) {
      const base = new Date(Date.UTC(1899, 11, 30));
      const date = new Date(base.getTime() + serial * 86400000);
      return date.toLocaleDateString("en-GB");
    }

    function formatCell(value) {
      const val = value.trim();
      if (!val) return `<span class="muted">‚Äî</span>`;
      if (/^n$/i.test(val)) return `<span class="no">‚ùå N</span>`;
      if (/^\d+$/.test(val)) {
        const n = Number(val);
        if (n >= 30000 && n <= 60000) return `<span class="ok">‚úÖ ${excelSerialToDate(n)}</span>`;
      }
      return `<span class="ok">‚úÖ ${val}</span>`;
    }

    async function loadSheet() {
      try {
        loading.style.display = "block";
        const res = await fetch(sheetUrl + "&t=" + Date.now());
        const text = await res.text();
        const rows = parseCSV(text);
        if (!rows.length) throw new Error("Empty data");

        loading.style.display = "none";
        thead.innerHTML = "";
        tbody.innerHTML = "";

        const headerRow = rows[0];
        const headerHTML = headerRow.map((h, i) => {
          if (i === 0) return `<th class="sticky-col">${h}</th>`;
          if (i === 1) return `<th class="sticky-col-2">${h}</th>`;
          return `<th>${h}</th>`;
        }).join("");
        thead.innerHTML = `<tr>${headerHTML}</tr>`;

        rows.slice(1).forEach(row => {
          const rowHTML = row.map((cell, i) => {
            if (i === 0) return `<td class="sticky-col">${cell}</td>`;
            if (i === 1) return `<td class="sticky-col-2">${cell}</td>`;
            return `<td>${formatCell(cell)}</td>`;
          }).join("");
          tbody.innerHTML += `<tr>${rowHTML}</tr>`;
        });

        const now = new Date();
        updated.textContent = `Last updated: ${now.toLocaleTimeString()}`;
      } catch (err) {
        console.error(err);
        loading.textContent = "‚ö†Ô∏è Error loading data.";
      }
    }

    loadSheet();
    setInterval(loadSheet, 120000);
  </script>
</body>
</html>
